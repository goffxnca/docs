"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2726],{95801:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>u});var n=r(85893),a=r(11151),i=r(71183);const s={id:"yield-resume",title:"Yield and Resume"},l=void 0,o={id:"build/smart-contracts/anatomy/yield-resume",title:"Yield and Resume",description:"NEAR smart contracts can yield execution, until an external service resumes them. In practice, the contract yields a cross-contract call to itself, until an external service executes a function and the contract decides to resume.",source:"@site/../docs/2.build/2.smart-contracts/anatomy/yield-resume.md",sourceDirName:"2.build/2.smart-contracts/anatomy",slug:"/build/smart-contracts/anatomy/yield-resume",permalink:"/docs/zh-CN/build/smart-contracts/anatomy/yield-resume",draft:!1,unlisted:!1,editUrl:"https://github.com/near/docs/edit/master/website/../docs/2.build/2.smart-contracts/anatomy/yield-resume.md",tags:[],version:"current",lastUpdatedBy:"Guille",lastUpdatedAt:1726751147e3,frontMatter:{id:"yield-resume",title:"Yield and Resume"},sidebar:"build",previous:{title:"Cross-Contract Calls",permalink:"/docs/zh-CN/build/smart-contracts/anatomy/crosscontract"},next:{title:"\u2705 Checklist",permalink:"/docs/zh-CN/build/smart-contracts/security/checklist"}},c={},u=[{value:"Yielding a Promise",id:"yielding-a-promise",level:2},{value:"Creating a Yielded Promise",id:"creating-a-yielded-promise",level:4},{value:"Retrieving the Yielded Promise ID",id:"retrieving-the-yielded-promise-id",level:4},{value:"Returning the Promise",id:"returning-the-promise",level:4},{value:"Signaling the Resume",id:"signaling-the-resume",level:2},{value:"The Function that Resumes",id:"the-function-that-resumes",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",strong:"strong",...(0,a.a)(),...e.components},{Details:r}=t;return r||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["NEAR smart contracts can ",(0,n.jsx)(t.strong,{children:"yield"})," execution, until an ",(0,n.jsx)(t.strong,{children:"external"})," service ",(0,n.jsx)(t.strong,{children:"resumes"})," them. In practice, the contract yields a ",(0,n.jsx)(t.strong,{children:"cross-contract call"})," to itself, until an external service executes a function and the contract decides to resume."]}),"\n",(0,n.jsxs)(t.p,{children:["This is a powerful feature that allows contracts to wait for external events, such as a response from an oracle, before continuing execution (read our ",(0,n.jsx)(t.a,{href:"/blog/yield-resume",children:"blog post"}),"!)."]}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsx)(t.p,{children:'Contract can wait for 200 blocks - around 4 minutes - after which the yielded function will execute, receiving a "timeout error" as input'})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"yielding-a-promise",children:"Yielding a Promise"}),"\n",(0,n.jsx)(t.p,{children:'Let\'s look at an example that takes a prompt from a user (e.g. "What is 2+2"), and yields the execution until an external service provides a response.'}),"\n",(0,n.jsx)(i.O2,{children:(0,n.jsx)(i.SQ,{value:"rust",language:"rust",children:(0,n.jsx)(i.Ey,{fname:"lib.rs",url:"https://github.com/near-examples/yield-resume/blob/main/contract/src/lib.rs",start:"43",end:"70"})})}),"\n",(0,n.jsx)(t.h4,{id:"creating-a-yielded-promise",children:"Creating a Yielded Promise"}),"\n",(0,n.jsxs)(t.p,{children:["In the example above, we are creating a ",(0,n.jsx)(t.a,{href:"/docs/zh-CN/build/smart-contracts/anatomy/crosscontract#promises",children:(0,n.jsx)(t.code,{children:"Promise"})})," to call the contract's function ",(0,n.jsx)(t.code,{children:"return_external_response"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["Notice that we create the ",(0,n.jsx)(t.code,{children:"Promise"})," using ",(0,n.jsx)(t.code,{children:"env::promise_yield_create"}),", which will create an ",(0,n.jsx)(t.strong,{children:"identifier"})," for the yielded promise in the ",(0,n.jsx)(t.code,{children:"YIELD_REGISTER"}),"."]}),"\n",(0,n.jsx)(t.h4,{id:"retrieving-the-yielded-promise-id",children:"Retrieving the Yielded Promise ID"}),"\n",(0,n.jsxs)(t.p,{children:["We read the ",(0,n.jsx)(t.code,{children:"YIELD_REGISTER"})," to retrieve the ",(0,n.jsx)(t.code,{children:"ID"})," of our yielded promise. We store the ",(0,n.jsx)(t.code,{children:"yield_id"})," and the user's ",(0,n.jsx)(t.code,{children:"prompt"})," so the external service query them (the contract exposes has a function to list all requests)."]}),"\n",(0,n.jsx)(t.h4,{id:"returning-the-promise",children:"Returning the Promise"}),"\n",(0,n.jsxs)(t.p,{children:["Finally, we return the ",(0,n.jsx)(t.code,{children:"Promise"}),", which will ",(0,n.jsx)(t.strong,{children:"not execute immediately"}),", but will be ",(0,n.jsx)(t.strong,{children:"yielded"})," until the external service provides a response."]}),"\n",(0,n.jsxs)(r,{children:[(0,n.jsxs)("summary",{children:[" What is that ",(0,n.jsx)(t.code,{children:"self.request_id"})," in the code? "]}),(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"self.request_id"})," is an internal unique identifier that we use to keep track of stored requests. This way, we can delete the request once the external service provides a response (or the waiting times out)"]}),(0,n.jsx)(t.p,{children:"Since we only use it to simplify the process of keeping track of the requests, you can remove it if you have a different way of tracking requests (e.g. an indexer)"})]}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"signaling-the-resume",children:"Signaling the Resume"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"env::promise_yield_resume"})," function allows us to signal which yielded promise should execute, as well as which parameters to pass to the resumed function."]}),"\n",(0,n.jsx)(i.O2,{children:(0,n.jsx)(i.SQ,{value:"rust",language:"rust",children:(0,n.jsx)(i.Ey,{fname:"lib.rs",url:"https://github.com/near-examples/yield-resume/blob/main/contract/src/lib.rs",start:"72",end:"75"})})}),"\n",(0,n.jsxs)(t.p,{children:["In the example above, the ",(0,n.jsx)(t.code,{children:"respond"})," function would be called by an external service, passing which promise should be resume (",(0,n.jsx)(t.code,{children:"yield_id"}),"), and the response to the prompt."]}),"\n",(0,n.jsx)(t.admonition,{title:"Gatekeeping the Resume",type:"warning",children:(0,n.jsx)(t.p,{children:"Since the function used to signal the resume is public, developers must make sure to guard it properly to avoid unwanted calls. This can be done by simply checking the caller of the function"})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"the-function-that-resumes",children:"The Function that Resumes"}),"\n",(0,n.jsx)(t.p,{children:"The function being resumed will have access to all parameters passed to it, including those passed during the yield creation, or the external service response."}),"\n",(0,n.jsx)(i.O2,{children:(0,n.jsx)(i.SQ,{value:"rust",language:"rust",children:(0,n.jsx)(i.Ey,{fname:"lib.rs",url:"https://github.com/near-examples/yield-resume/blob/main/contract/src/lib.rs",start:"77",end:"89"})})}),"\n",(0,n.jsxs)(t.p,{children:["In the example above, the ",(0,n.jsx)(t.code,{children:"return_external_response"})," receives two parameters:"]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["A ",(0,n.jsx)(t.code,{children:"request_id"})," - passed on ",(0,n.jsx)(t.a,{href:"#creating-a-yielded-promise",children:"creation"})," - which is used to remove the request from the state"]}),"\n",(0,n.jsxs)(t.li,{children:["A ",(0,n.jsx)(t.code,{children:"response"})," - passed when ",(0,n.jsx)(t.a,{href:"#signaling-the-resume",children:"signaling to resume"})," - which contains the external response, or a ",(0,n.jsx)(t.code,{children:"PromiseError"})," if the contract timed out while waiting"]}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{title:"There's plenty of time",type:"tip",children:(0,n.jsx)(t.p,{children:"The contract will be able to wait for 200 blocks - around 4 minutes - before timing out"})}),"\n",(0,n.jsxs)(t.admonition,{type:"info",children:[(0,n.jsx)(t.p,{children:"Notice that, in this particular example, we choose to return a value both if there is a response or a time out"}),(0,n.jsxs)(t.p,{children:["The reason to not raise an error, is because we are changing the state (removing the request in line ",(0,n.jsx)(t.code,{children:"#7"}),"), and raising an error would revert this state change"]})]})]})}function h(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},85162:(e,t,r)=>{r.d(t,{Z:()=>s});r(67294);var n=r(36905);const a={tabItem:"tabItem_Ymn6"};var i=r(85893);function s(e){var t=e.children,r=e.hidden,s=e.className;return(0,i.jsx)("div",{role:"tabpanel",className:(0,n.Z)(a.tabItem,s),hidden:r,children:t})}},74866:(e,t,r)=>{r.d(t,{Z:()=>w});var n=r(67294),a=r(36905),i=r(12466),s=r(16550),l=r(20469),o=r(91980),c=r(67392),u=r(20812);function d(e){var t,r;return null!=(t=null==(r=n.Children.toArray(e).filter((function(e){return"\n"!==e})).map((function(e){if(!e||(0,n.isValidElement)(e)&&((t=e.props)&&"object"==typeof t&&"value"in t))return e;var t;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:r.filter(Boolean))?t:[]}function h(e){var t=e.values,r=e.children;return(0,n.useMemo)((function(){var e=null!=t?t:function(e){return d(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}(r);return function(e){var t=(0,c.lx)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,r])}function m(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function p(e){var t=e.queryString,r=void 0!==t&&t,a=e.groupId,i=(0,s.k6)(),l=function(e){var t=e.queryString,r=void 0!==t&&t,n=e.groupId;if("string"==typeof r)return r;if(!1===r)return null;if(!0===r&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=n?n:null}({queryString:r,groupId:a});return[(0,o._X)(l),(0,n.useCallback)((function(e){if(l){var t=new URLSearchParams(i.location.search);t.set(l,e),i.replace(Object.assign({},i.location,{search:t.toString()}))}}),[l,i])]}function f(e){var t,r,a,i,s=e.defaultValue,o=e.queryString,c=void 0!==o&&o,d=e.groupId,f=h(e),g=(0,n.useState)((function(){return function(e){var t,r=e.defaultValue,n=e.tabValues;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(r){if(!m({value:r,tabValues:n}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+r+'" but none of its children has the corresponding value. Available values are: '+n.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return r}var a=null!=(t=n.find((function(e){return e.default})))?t:n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:s,tabValues:f})})),x=g[0],v=g[1],b=p({queryString:c,groupId:d}),j=b[0],y=b[1],w=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:d}.groupId),r=(0,u.Nk)(t),a=r[0],i=r[1],[a,(0,n.useCallback)((function(e){t&&i.set(e)}),[t,i])]),k=w[0],I=w[1],E=function(){var e=null!=j?j:k;return m({value:e,tabValues:f})?e:null}();return(0,l.Z)((function(){E&&v(E)}),[E]),{selectedValue:x,selectValue:(0,n.useCallback)((function(e){if(!m({value:e,tabValues:f}))throw new Error("Can't select invalid tab value="+e);v(e),y(e),I(e)}),[y,I,f]),tabValues:f}}var g=r(72389);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var v=r(85893);function b(e){var t=e.className,r=e.block,n=e.selectedValue,s=e.selectValue,l=e.tabValues,o=[],c=(0,i.o5)().blockElementScrollPositionUntilNextRender,u=function(e){var t=e.currentTarget,r=o.indexOf(t),a=l[r].value;a!==n&&(c(t),s(a))},d=function(e){var t,r=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":var n,a=o.indexOf(e.currentTarget)+1;r=null!=(n=o[a])?n:o[0];break;case"ArrowLeft":var i,s=o.indexOf(e.currentTarget)-1;r=null!=(i=o[s])?i:o[o.length-1]}null==(t=r)||t.focus()};return(0,v.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.Z)("tabs",{"tabs--block":r},t),children:l.map((function(e){var t=e.value,r=e.label,i=e.attributes;return(0,v.jsx)("li",Object.assign({role:"tab",tabIndex:n===t?0:-1,"aria-selected":n===t,ref:function(e){return o.push(e)},onKeyDown:d,onClick:u},i,{className:(0,a.Z)("tabs__item",x.tabItem,null==i?void 0:i.className,{"tabs__item--active":n===t}),children:null!=r?r:t}),t)}))})}function j(e){var t=e.lazy,r=e.children,i=e.selectedValue,s=(Array.isArray(r)?r:[r]).filter(Boolean);if(t){var l=s.find((function(e){return e.props.value===i}));return l?(0,n.cloneElement)(l,{className:(0,a.Z)("margin-top--md",l.props.className)}):null}return(0,v.jsx)("div",{className:"margin-top--md",children:s.map((function(e,t){return(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==i})}))})}function y(e){var t=f(e);return(0,v.jsxs)("div",{className:(0,a.Z)("tabs-container",x.tabList),children:[(0,v.jsx)(b,Object.assign({},t,e)),(0,v.jsx)(j,Object.assign({},t,e))]})}function w(e){var t=(0,g.Z)();return(0,v.jsx)(y,Object.assign({},e,{children:d(e.children)}),String(t))}},71183:(e,t,r)=>{r.d(t,{O2:()=>p,Ey:()=>g,SQ:()=>f});var n=r(67294),a=r(74866),i=r(85162),s=r(74165),l=r(15861),o=r(1841),c=r.n(o),u=r(85893);function d(){return(d=(0,l.Z)((0,s.Z)().mark((function e(t,r,n){var a,i,l,o;return(0,s.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=localStorage.getItem(t+"-until"))&&i>Date.now())){e.next=5;break}a=localStorage.getItem(t),e.next=18;break;case 5:return e.prev=5,e.next=8,fetch(t);case 8:return e.next=10,e.sent.text();case 10:a=e.sent,localStorage.setItem(t,a),localStorage.setItem(t+"-until",Date.now()+6e4),e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(5),e.abrupt("return","Error fetching code, please try reloading");case 18:return l=a.split("\n"),r=r?Number(r)-1:0,n=n?Number(n):l.length,l=l.slice(r,n),o=l.reduce((function(e,t){if(0===t.length)return e;var r=t.match(/^\s+/);return r?Math.min(e,r[0].length):0}),1/0),e.abrupt("return",l.map((function(e){return e.slice(o)})).join("\n"));case 24:case"end":return e.stop()}}),e,null,[[5,15]])})))).apply(this,arguments)}const h=function(e){var t=e.url,r=e.start,a=e.end,i=e.language,s=e.fname,l=e.metastring,o=(0,n.useState)("Loading..."),h=o[0],m=o[1];return(0,n.useEffect)((function(){var e=function(e){var t=e.slice(e.indexOf("https")).split("#"),r=t[0],n=(t[1],new URL(r).pathname.split("/").slice(1)),a=n[0],i=n[1];return n[2],"https://raw.githubusercontent.com/"+a+"/"+i+"/"+n[3]+"/"+n.slice(4).join("/")}(t),n=function(e,t,r){return d.apply(this,arguments)}(e,r,a);n.then((function(e){return m(e)}))})),(0,u.jsxs)("div",{fname:s,children:[(0,u.jsx)(c(),{language:i,metastring:l+" showLineNumbers",children:h}),(0,u.jsx)("div",{style:{fontSize:"0.9em",fontWeight:600,color:"rgb(14, 117, 221)",textAlign:"center",paddingBottom:"13px",textDecoration:"underline"},children:(0,u.jsx)("a",{href:t,target:"_blank",rel:"noreferrer noopener",children:"See full example on GitHub"})})]})};var m={rust:"\ud83e\udd80 Rust",js:"\ud83c\udf10 Javascript",ts:"\ud83c\udf10 Typescript"};function p(e){var t=e.children;return Array.isArray(t)||(t=[t]),(0,u.jsx)(a.Z,{className:"language-tabs",groupId:"code-tabs",children:t.map((function(e,t){return(0,u.jsx)(i.Z,{value:e.props.value,label:m[e.props.value],children:e})}))})}function f(e){var t=e.children,r=e.language,n=e.showSingleFName;return Array.isArray(t)||(t=[t]),t=t.map((function(e){return function(e,t){var r=e.props,n=(r.children,r.url),a=r.start,i=r.end,s=r.fname;if(e.type===g)return g({url:n,start:a,end:i,language:t,fname:s});return e}(e,r)})),1!=t.length||n?(0,u.jsx)(a.Z,{className:"file-tabs",children:t.map((function(e,t){return(0,u.jsx)(i.Z,{value:t,label:e.props.fname,children:e})}))}):(0,u.jsx)(i.Z,{value:0,label:t[0].props.fname,children:t[0]})}function g(e){var t=e.url,r=e.start,n=e.end,a=e.language,i=e.fname,s=e.metastring;return h({url:t,start:r,end:n,language:a,fname:i,metastring:s})}}}]);