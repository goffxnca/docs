"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2251],{93614:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>c,default:()=>j,frontMatter:()=>o,metadata:()=>d,toc:()=>u});var s=n(85893),r=n(11151),i=n(71183),l=n(74866),a=n(85162);const o={id:"collections",title:"Collections"},c=void 0,d={id:"build/smart-contracts/anatomy/collections",title:"Collections",description:"When deciding on data structures it is important to understand their tradeoffs. Choosing the wrong structure can create a bottleneck as the application scales, and migrating the state to the new data structures will come at a cost.",source:"@site/../_docs/2.build/2.smart-contracts/anatomy/collections.md",sourceDirName:"2.build/2.smart-contracts/anatomy",slug:"/build/smart-contracts/anatomy/collections",permalink:"/docs/build/smart-contracts/anatomy/collections",draft:!1,unlisted:!1,editUrl:"https://github.com/near/docs/edit/master/website/../_docs/2.build/2.smart-contracts/anatomy/collections.md",tags:[],version:"current",frontMatter:{id:"collections",title:"Collections"},sidebar:"build",previous:{title:"SDK Types",permalink:"/docs/build/smart-contracts/anatomy/types"},next:{title:"Environment",permalink:"/docs/build/smart-contracts/anatomy/environment"}},h={},u=[{value:"Native Collections",id:"native-collections",level:2},{value:"SDK Collections",id:"sdk-collections",level:2},{value:"Exposed Collections",id:"exposed-collections",level:3},{value:"Features",id:"features",level:3},{value:"Complexity",id:"complexity",level:3},{value:"SDK Collections Cookbook",id:"sdk-collections-cookbook",level:2},{value:"Instantiation",id:"instantiation",level:3},{value:"Vector",id:"vector",level:3},{value:"LookupMap",id:"lookupmap",level:3},{value:"UnorderedMap / IterableMap",id:"unorderedmap--iterablemap",level:3},{value:"LookupSet",id:"lookupset",level:3},{value:"UnorderedSet / IterableSet",id:"unorderedset--iterableset",level:3},{value:"Tree",id:"tree",level:3},{value:"LazyOption (Legacy)",id:"lazyoption-legacy",level:3},{value:"Nesting Collections",id:"nesting-collections",level:2},{value:"Error prone patterns",id:"error-prone-patterns",level:2},{value:"Nesting Errors",id:"nesting-errors",level:3},{value:"Pagination",id:"pagination",level:2},{value:"Storage Cost",id:"storage-cost",level:2},{value:"Storage Constraints on NEAR",id:"storage-constraints-on-near",level:2}];function x(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components},{Details:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"When deciding on data structures it is important to understand their tradeoffs. Choosing the wrong structure can create a bottleneck as the application scales, and migrating the state to the new data structures will come at a cost."}),"\n",(0,s.jsx)(t.p,{children:"You can choose between two types of collections:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Native collections (e.g. ",(0,s.jsx)(t.code,{children:"Array"}),", ",(0,s.jsx)(t.code,{children:"Map"}),", ",(0,s.jsx)(t.code,{children:"Set"}),"), provided by the language"]}),"\n",(0,s.jsxs)(t.li,{children:["SDK collections (e.g. ",(0,s.jsx)(t.code,{children:"IterableMap"}),", ",(0,s.jsx)(t.code,{children:"Vector"}),"), provided by the NEAR SDK"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Understanding how the contract stores and loads both types of collections is crucial to decide which one to use."}),"\n",(0,s.jsxs)(t.admonition,{title:"Native vs SDK Collections",type:"tip",children:[(0,s.jsx)(t.p,{children:"Use native collections for small amounts of data that need to be accessed altogether, and SDK collections for large amounts of data that do not need to be accessed altogether."}),(0,s.jsxs)(t.p,{children:["If your collection has up to 100 entries, it's acceptable to use the native collection. For larger ones, prefer to use SDK collection. For comparison please refer to ",(0,s.jsx)(t.a,{href:"https://www.github.com/volodymyr-matselyukh/near-benchmarking",children:"this benchmark"}),"."]})]}),"\n",(0,s.jsxs)(n,{children:[(0,s.jsx)("summary",{children:" How the State is Handled "}),(0,s.jsxs)(t.p,{children:["Each time the contract is executed, the first thing it will do is to read the values and ",(0,s.jsx)(t.a,{href:"/docs/build/smart-contracts/anatomy/serialization",children:"deserialize"})," them into memory, and after the function finishes, it will ",(0,s.jsx)(t.a,{href:"/docs/build/smart-contracts/anatomy/serialization",children:"serialize"})," and write the values back to the database."]}),(0,s.jsx)(t.p,{children:"For native collections, the contract will fully load the collection into memory before any method executes. This happens even if the method you invoke does not use the collection. Know that this will have impact on GAS you spend for methods in your contract."})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"native-collections",children:"Native Collections"}),"\n",(0,s.jsx)(t.p,{children:"Native collections are those provided by the language:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["JS: ",(0,s.jsx)(t.code,{children:"Array"}),", ",(0,s.jsx)(t.code,{children:"Set"}),", ",(0,s.jsx)(t.code,{children:"Map"}),", ",(0,s.jsx)(t.code,{children:"Object"})," ..."]}),"\n",(0,s.jsxs)(t.li,{children:["Rust: ",(0,s.jsx)(t.code,{children:"Vector"}),", ",(0,s.jsx)(t.code,{children:"HashMap"}),", ",(0,s.jsx)(t.code,{children:"Set"})," ..."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["All entries in a native collection are ",(0,s.jsx)(t.strong,{children:"serialized into a single value"})," and ",(0,s.jsx)(t.strong,{children:"stored together"})," into the state. This means that every time a function execute, the SDK will read and ",(0,s.jsx)(t.strong,{children:"deserialize all entries"})," in the native collection."]}),"\n",(0,s.jsxs)(n,{children:[(0,s.jsx)("summary",{children:" Serialization & Storage Example "}),(0,s.jsxs)(t.p,{children:["The array ",(0,s.jsx)(t.code,{children:"[1,2,3,4]"})," will be serialized into the JSON string ",(0,s.jsx)(t.code,{children:'"[1,2,3,4]"'})," in Javascript, and the Borsh byte-stream ",(0,s.jsx)(t.code,{children:"[0,0,0,4,1,2,3,4]"})," in Rust before being stored"]})]}),"\n",(0,s.jsx)(t.admonition,{title:"When to use them",type:"tip",children:(0,s.jsx)(t.p,{children:"Native collections are useful if you are planning to store smalls amounts of data that need to be accessed all together"})}),"\n",(0,s.jsx)(t.admonition,{title:"Keep Native Collections Small",type:"danger",children:(0,s.jsx)(t.p,{children:"As the native collection grows, deserializing it from memory will cost more and more gas. If the collections grows too large, your contract might expend all the gas trying to read its state, making it fail on each function call"})}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"sdk-collections",children:"SDK Collections"}),"\n",(0,s.jsx)(t.p,{children:'The NEAR SDKs expose collections that are optimized for random access of large amounts of data. SDK collections are instantiated using a "prefix", which is used as an index to split the data into chunks. This way, SDK collections can defer reading and writing to the store until needed.'}),"\n",(0,s.jsx)(t.p,{children:"These collections are built to have an interface similar to native collections."}),"\n",(0,s.jsxs)(n,{children:[(0,s.jsx)("summary",{children:" Serialization & Storage Example "}),(0,s.jsxs)(t.p,{children:["The sdk array ",(0,s.jsx)(t.code,{children:"[1,2,3,4]"})," with prefix ",(0,s.jsx)(t.code,{children:'"p"'})," will be stored as the string ",(0,s.jsx)(t.code,{children:'"p"'})," in the contract's attribute, and create four entries in the contract's storage: ",(0,s.jsx)(t.code,{children:"p-0:1"}),", ",(0,s.jsx)(t.code,{children:"p-1:2"}),"..."]})]}),"\n",(0,s.jsx)(t.admonition,{title:"when to use them",type:"tip",children:(0,s.jsx)(t.p,{children:"SDK collections are useful when you are planning to store large amounts of data that do not need to be accessed all together"})}),"\n",(0,s.jsx)("hr",{class:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"exposed-collections",children:"Exposed Collections"}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"SDK Collection"}),(0,s.jsx)(t.th,{children:"Native Equivalent"}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Vector"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Array"})}),(0,s.jsx)(t.td,{children:"A growable array type. The values are sharded in memory and can be used for iterable and indexable values that are dynamically sized."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"LookupSet"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Set"})}),(0,s.jsxs)(t.td,{children:["A set, which is similar to ",(0,s.jsx)(t.code,{children:"LookupMap"})," but without storing values, can be used for checking the unique existence of values. This structure is not iterable and can only be used for lookups."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"UnorderedSet"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Set"})}),(0,s.jsxs)(t.td,{children:["An iterable equivalent of ",(0,s.jsx)(t.code,{children:"LookupSet"})," which stores additional metadata for the elements contained in the set."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"LookupMap"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Map"})}),(0,s.jsx)(t.td,{children:"This structure behaves as a thin wrapper around the key-value storage available to contracts. This structure does not contain any metadata about the elements in the map, so it is not iterable."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"UnorderedMap"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Map"})}),(0,s.jsxs)(t.td,{children:["Similar to ",(0,s.jsx)(t.code,{children:"LookupMap"}),", except that it stores additional data to be able to iterate through elements in the data structure."]})]})]})]})}),(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"SDK collection"}),(0,s.jsxs)(t.th,{children:[(0,s.jsx)(t.code,{children:"std"}),"\xa0equivalent"]}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"store::Vector<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Vec<T>"})}),(0,s.jsx)(t.td,{children:"A growable array type. The values are sharded in memory and can be used for iterable and indexable values that are dynamically sized."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["store::LookupMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["HashMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:"This structure behaves as a thin wrapper around the key-value storage available to contracts. This structure does not contain any metadata about the elements in the map, so it is not iterable."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["store::IterableMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["HashMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsxs)(t.td,{children:["Similar to ",(0,s.jsx)(t.code,{children:"LookupMap"}),", except that it stores additional data to be able to iterate through elements in the data structure."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["store::UnorderedMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["HashMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsxs)(t.td,{children:["Similar to ",(0,s.jsx)(t.code,{children:"LookupMap"}),", except that it stores additional data to be able to iterate through elements in the data structure."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"store::LookupSet<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"HashSet<T>"})}),(0,s.jsxs)(t.td,{children:["A set, which is similar to ",(0,s.jsx)(t.code,{children:"LookupMap"})," but without storing values, can be used for checking the unique existence of values. This structure is not iterable and can only be used for lookups."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"store::IterableSet<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"HashSet<T>"})}),(0,s.jsxs)(t.td,{children:["An iterable equivalent of ",(0,s.jsx)(t.code,{children:"LookupSet"})," which stores additional metadata for the elements contained in the set."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"store::UnorderedSet<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"HashSet<T>"})}),(0,s.jsxs)(t.td,{children:["An iterable equivalent of ",(0,s.jsx)(t.code,{children:"LookupSet"})," which stores additional metadata for the elements contained in the set."]})]})]})]})}),(0,s.jsxs)(a.Z,{value:"rust-legacy",label:"\ud83e\udd80 Rust (legacy)",children:[(0,s.jsx)(t.admonition,{title:"Note",type:"info",children:(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"near_sdk::collections"})," is now deprecated in favor of ",(0,s.jsx)(t.code,{children:"near_sdk::store"}),". To use ",(0,s.jsx)(t.code,{children:"near_sdk::collections"})," you will have to use the ",(0,s.jsxs)(t.a,{href:"https://github.com/near-examples/storage-examples/blob/2a138a6e8915e08ce76718add3e36c04c2ea2fbb/collections-rs/legacy/Cargo.toml#L11",children:[(0,s.jsx)(t.code,{children:"legacy"})," feature"]}),"."]})}),(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"SDK collection"}),(0,s.jsxs)(t.th,{children:[(0,s.jsx)(t.code,{children:"std"}),"\xa0equivalent"]}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"collections::Vector<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Vec<T>"})}),(0,s.jsx)(t.td,{children:"A growable array type. The values are sharded in memory and can be used for iterable and indexable values that are dynamically sized."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["collections::LookupMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["HashMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:"This structure behaves as a thin wrapper around the key-value storage available to contracts. This structure does not contairn any metadata about the elements in the map, so it is not iterable."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["collections::UnorderedMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["HashMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsxs)(t.td,{children:["Similar to ",(0,s.jsx)(t.code,{children:"LookupMap"}),", except that it stores additional data to be able to iterate through elements in the data structure."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["collections::TreeMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsx)(t.td,{children:(0,s.jsxs)("code",{children:["BTreeMap",(0,s.jsx)(t.code,{children:"<K,&nbsp;V>"})]})}),(0,s.jsxs)(t.td,{children:["An ordered equivalent of ",(0,s.jsx)(t.code,{children:"UnorderedMap"}),". The underlying implementation is based on an ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/AVL_tree",children:"AVL tree"}),". This structure should be used when a consistent order is needed or accessing the min/max keys is needed."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"collections::LookupSet<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"HashSet<T>"})}),(0,s.jsxs)(t.td,{children:["A set, which is similar to ",(0,s.jsx)(t.code,{children:"LookupMap"})," but without storing values, can be used for checking the unique existence of values. This structure is not iterable and can only be used for lookups."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"collections::UnorderedSet<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"HashSet<T>"})}),(0,s.jsxs)(t.td,{children:["An iterable equivalent of ",(0,s.jsx)(t.code,{children:"LookupSet"})," which stores additional metadata for the elements contained in the set."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"collections::LazyOption<T>"})}),(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Option<T>"})}),(0,s.jsxs)(t.td,{children:["Optional value in storage. This value will only be read from storage when interacted with. This value will be ",(0,s.jsx)(t.code,{children:"Some<T>"})," when the value is saved in storage, and ",(0,s.jsx)(t.code,{children:"None"})," if the value at the prefix does not exist."]})]})]})]})]})]}),"\n",(0,s.jsx)("hr",{class:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"features",children:"Features"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Iterable"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Clear All Values"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Preserves Insertion Order"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Range Selection"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Vector"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"LookupSet"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"UnorderedSet"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"IterableSet"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"LookupMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"UnorderedMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"IterableMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"}}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"TreeMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"\u2705"})]})]})]}),"\n",(0,s.jsx)("hr",{class:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"complexity",children:"Complexity"}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Access"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Insert"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Delete"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Search"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Traverse"}),(0,s.jsx)(t.th,{style:{textAlign:"center"},children:"Clear"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"Vector"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)*"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)**"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"LookupSet"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"N/A"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"N/A"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"UnorderedSet"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"IterableSet"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"LookupMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"N/A"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"N/A"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"IterableMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"TreeMap"})}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(1)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(log n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(log n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(log n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"}),(0,s.jsx)(t.td,{style:{textAlign:"center"},children:"O(n)"})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsxs)(t.em,{children:["* - to insert at the end of the vector using ",(0,s.jsx)(t.code,{children:"push_back"})," (or ",(0,s.jsx)(t.code,{children:"push_front"})," for deque)"]}),"\n",(0,s.jsxs)(t.em,{children:["** - to delete from the end of the vector using ",(0,s.jsx)(t.code,{children:"pop"})," (or ",(0,s.jsx)(t.code,{children:"pop_front"})," for deque), or delete using ",(0,s.jsx)(t.code,{children:"swap_remove"})," which swaps the element with the last element of the vector and then removes it."]})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"sdk-collections-cookbook",children:"SDK Collections Cookbook"}),"\n",(0,s.jsx)(t.p,{children:"Let's see how to use the SDK collections in practice"}),"\n",(0,s.jsx)("hr",{class:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"instantiation",children:"Instantiation"}),"\n",(0,s.jsxs)(t.p,{children:["All structures need to be initialized using a ",(0,s.jsxs)(t.strong,{children:["unique ",(0,s.jsx)(t.code,{children:"prefix"})]}),", which will be used to index the collection's values in the account's state"]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsxs)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:[(0,s.jsx)(i.Ey,{fname:"contract.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"6",end:"21"}),(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["Do not forget to use the ",(0,s.jsx)(t.code,{children:"schema"})," to define how your contract's state is structured"]})})]}),(0,s.jsxs)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:[(0,s.jsx)(i.Ey,{fname:"lib.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/lib.rs",start:"24",end:"47"}),(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["Notice how we use ",(0,s.jsx)(t.code,{children:"enums"})," to ensure all collections have a different prefix. Another advantage of using ",(0,s.jsx)(t.code,{children:"enums"})," is that they are serialized into a single ",(0,s.jsx)(t.code,{children:"byte"})," prefix."]})})]}),(0,s.jsxs)(a.Z,{value:"rust-legacy",label:"\ud83e\udd80 Rust (legacy)",children:[(0,s.jsx)(i.Ey,{fname:"lib.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/legacy/src/lib.rs",start:"33",end:"62"}),(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["Notice how we use ",(0,s.jsx)(t.code,{children:"enums"})," to ensure all collections have a different prefix. Another advantage of using ",(0,s.jsx)(t.code,{children:"enums"})," is that they are serialized into a single ",(0,s.jsx)(t.code,{children:"byte"})," prefix."]})})]})]}),"\n",(0,s.jsx)(t.admonition,{type:"danger",children:(0,s.jsx)(t.p,{children:"Be careful of not using the same prefix in two collections, otherwise, their storage space will collide, and you might overwrite information from one collection when writing in the other"})}),"\n",(0,s.jsx)("hr",{className:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"vector",children:"Vector"}),"\n",(0,s.jsxs)(t.p,{children:["Implements a ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Array_data_structure",children:"vector/array"})," which persists in the contract's storage. Please refer to the Rust and JS SDK's for a full reference on their interfaces."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsx)(i.Ey,{fname:"contract.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"34",end:"58"})}),(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsx)(i.Ey,{fname:"vector.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/vector.rs",start:"4",end:"29"})}),(0,s.jsx)(a.Z,{value:"rust-legacy",label:"\ud83e\udd80 Rust (legacy)",children:(0,s.jsx)(i.Ey,{fname:"vector.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/legacy/src/vector.rs",start:"6",end:"31"})})]}),"\n",(0,s.jsx)("hr",{className:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"lookupmap",children:"LookupMap"}),"\n",(0,s.jsxs)(t.p,{children:["Implements a ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Associative_array",children:"map/dictionary"})," which persists in the contract's storage. Please refer to the Rust and JS SDK's for a full reference on their interfaces."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsx)(i.Ey,{fname:"contract.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"97",end:"116"})}),(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsx)(i.Ey,{fname:"lookup_map.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/lookup_map.rs",start:"4",end:"22"})})]}),"\n",(0,s.jsx)("hr",{className:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"unorderedmap--iterablemap",children:"UnorderedMap / IterableMap"}),"\n",(0,s.jsxs)(t.p,{children:["Implements a ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Associative_array",children:"map/dictionary"})," which persists in the contract's storage. Please refer to the Rust and JS SDK's for a full reference on their interfaces."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsx)(i.Ey,{fname:"contract.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"118",end:"137"})}),(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsx)(i.Ey,{fname:"iterable_map.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/iterable_map.rs",start:"4",end:"29"})})]}),"\n",(0,s.jsx)("hr",{className:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"lookupset",children:"LookupSet"}),"\n",(0,s.jsxs)(t.p,{children:["Implements a ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Set_(abstract_data_type)",children:"set"})," which persists in the contract's storage. Please refer to the Rust and JS SDK's for a full reference on their interfaces."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsx)(i.Ey,{fname:"contract.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"60",end:"74"})}),(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsx)(i.Ey,{fname:"lookup_set.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/lookup_set.rs",start:"4",end:"18"})})]}),"\n",(0,s.jsx)("hr",{className:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"unorderedset--iterableset",children:"UnorderedSet / IterableSet"}),"\n",(0,s.jsxs)(t.p,{children:["Implements a ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Associative_array",children:"map/dictionary"})," which persists in the contract's storage. Please refer to the Rust and JS SDK's for a full reference on their interfaces."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsx)(i.Ey,{fname:"contract.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"76",end:"95"})}),(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsx)(i.Ey,{fname:"iterable_set.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/iterable_set.rs",start:"4",end:"26"})})]}),"\n",(0,s.jsx)("hr",{className:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"tree",children:"Tree"}),"\n",(0,s.jsxs)(t.p,{children:["An ordered equivalent of Map. The underlying implementation is based on an ",(0,s.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/AVL_tree",children:"AVL"}),". You should use this structure when you need to: have a consistent order, or access the min/max keys."]}),"\n",(0,s.jsx)(l.Z,{groupId:"code-tabs",children:(0,s.jsx)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,s.jsx)(i.Ey,{fname:"tree.rs",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/legacy/src/tree.rs",start:"6",end:"24"})})}),"\n",(0,s.jsx)("hr",{class:"subsection"}),"\n",(0,s.jsx)(t.h3,{id:"lazyoption-legacy",children:"LazyOption (Legacy)"}),"\n",(0,s.jsx)(t.p,{children:"LazyOptions are great to store large values (i.e. a wasm file), since its value will not be read from storage until it is interacted with."}),"\n",(0,s.jsxs)(t.p,{children:["It acts like an ",(0,s.jsx)(t.code,{children:"Option"})," that can either hold a value or not and also requires a unique prefix (a key in this case)\nlike other persistent collections."]}),"\n",(0,s.jsxs)(t.p,{children:["Compared to other collections, ",(0,s.jsx)(t.code,{children:"LazyOption"})," only allows you to initialize the value during initialization."]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"nesting-collections",children:"Nesting Collections"}),"\n",(0,s.jsxs)(t.p,{children:["When nesting SDK collections, be careful to ",(0,s.jsx)(t.strong,{children:"use different prefixes"})," for all collections, including the nested ones."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsx)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,s.jsx)(i.Ey,{fname:"nested.ts",language:"js",url:"https://github.com/near-examples/storage-examples/blob/main/collections-js/src/contract.ts",start:"140",end:"182"})}),(0,s.jsxs)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:[(0,s.jsx)(i.Ey,{fname:"nested.ts",language:"rust",url:"https://github.com/near-examples/storage-examples/blob/main/collections-rs/store/src/nested.rs",start:"4",end:"30"}),(0,s.jsx)(t.admonition,{type:"tip",children:(0,s.jsxs)(t.p,{children:["Notice how we use ",(0,s.jsx)(t.code,{children:"enums"})," that take a ",(0,s.jsx)(t.code,{children:"String"})," argument to ensure all collections have a different prefix"]})})]})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"error-prone-patterns",children:"Error prone patterns"}),"\n",(0,s.jsx)(t.p,{children:"Because the values are not kept in memory and are lazily loaded from storage, it's important to make sure if a collection is replaced or removed, that the storage is cleared. In addition, it is important that if the collection is modified, the collection itself is updated in state because most collections will store some metadata."}),"\n",(0,s.jsx)(t.p,{children:"Some error-prone patterns to avoid that cannot be restricted at the type level are:"}),"\n",(0,s.jsx)(l.Z,{children:(0,s.jsxs)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:[(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:'use near_sdk::store::UnorderedMap;\n\nlet mut m = UnorderedMap::<u8, String>::new(b"m");\nm.insert(1, "test".to_string());\nassert_eq!(m.len(), 1);\nassert_eq!(m.get(&1), Some(&"test".to_string()));\n\n// Bug 1: Should not replace any collections without clearing state, this will reset any\n// metadata, such as the number of elements, leading to bugs. If you replace the collection\n// with something with a different prefix, it will be functional, but you will lose any\n// previous data and the old values will not be removed from storage.\nm = UnorderedMap::new(b"m");\nassert!(m.is_empty());\nassert_eq!(m.get(&1), Some(&"test".to_string()));\n\n// Bug 2: Should not use the same prefix as another collection\n// or there will be unexpected side effects.\nlet m2 = UnorderedMap::<u8, String>::new(b"m");\nassert!(m2.is_empty());\nassert_eq!(m2.get(&1), Some(&"test".to_string()));\n\n// Bug 3: forgetting to save the collection in storage. When the collection is attached to\n// the contract state (`self` in `#[near]`) this will be done automatically, but if\n// interacting with storage manually or working with nested collections, this is relevant.\nuse near_sdk::store::Vector;\n\n// Simulate roughly what happens during a function call that initializes state.\n{\n    let v = Vector::<u8>::new(b"v");\n    near_sdk::env::state_write(&v);\n}\n\n// Simulate what happens during a function call that just modifies the collection\n// but does not store the collection itself.\n{\n    let mut v: Vector<u8> = near_sdk::env::state_read().unwrap();\n    v.push(1);\n    // The bug is here that the collection itself if not written back\n}\n\nlet v: Vector<u8> = near_sdk::env::state_read().unwrap();\n// This will report as if the collection is empty, even though the element exists\nassert!(v.get(0).is_none());\nassert!(\n    near_sdk::env::storage_read(&[b"v".as_slice(), &0u32.to_le_bytes()].concat()).is_some()\n);\n\n// Bug 4 (only relevant for `near_sdk::store`): These collections will cache writes as well\n// as reads, and the writes are performed on [`Drop`](https://doc.rust-lang.org/std/ops/trait.Drop.html)\n// so if the collection is kept in static memory or something like `std::mem::forget` is used,\n// the changes will not be persisted.\nuse near_sdk::store::IterableSet;\n\nlet mut m: IterableSet<u8> = IterableSet::new(b"l");\nm.insert(1);\nassert!(m.contains(&1));\n\n// This would be the fix, manually flushing the intermediate changes to storage.\n// m.flush();\nstd::mem::forget(m);\n\nm = IterableSet::new(b"l");\nassert!(!m.contains(&1));\n'})}),(0,s.jsx)("hr",{class:"subsection"}),(0,s.jsx)(t.h3,{id:"nesting-errors",children:"Nesting Errors"}),(0,s.jsxs)(t.p,{children:["By extension of the error-prone patterns to avoid mentioned in the ",(0,s.jsx)(t.a,{href:"/docs/build/smart-contracts/anatomy/collections#error-prone-patterns",children:"collections section"}),", it is important to keep in mind how these bugs can easily be introduced into a contract when using nested collections."]}),(0,s.jsx)(t.p,{children:"Some issues for more context:"}),(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/near/near-sdk-rs/issues/560",children:"https://github.com/near/near-sdk-rs/issues/560"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://github.com/near/near-sdk-rs/issues/703",children:"https://github.com/near/near-sdk-rs/issues/703"})}),"\n"]}),(0,s.jsxs)(t.p,{children:["The following cases are the most commonly encountered bugs that cannot be restricted at the type level (only relevant for ",(0,s.jsx)(t.code,{children:"near_sdk::collections"}),", not ",(0,s.jsx)(t.code,{children:"near_sdk::store"}),"):"]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:'use near_sdk::borsh::{self, BorshSerialize};\nuse near_sdk::collections::{LookupMap, UnorderedSet};\nuse near_sdk::BorshStorageKey;\n\n#[derive(BorshStorageKey, BorshSerialize)]\npub enum StorageKey {\n    Root,\n    Nested(u8),\n}\n\n// Bug 1: Nested collection is removed without clearing its own state.\nlet mut root: LookupMap<u8, UnorderedSet<String>> = LookupMap::new(StorageKey::Root);\nlet mut nested = UnorderedSet::new(StorageKey::Nested(1));\nnested.insert(&"test".to_string());\nroot.insert(&1, &nested);\n\n// Remove inserted collection without clearing its sub-state.\nlet mut _removed = root.remove(&1).unwrap();\n\n// This line would fix the bug:\n// _removed.clear();\n\n// This collection will now be in an inconsistent state if an empty UnorderedSet is put\n// in the same entry of `root`.\nroot.insert(&1, &UnorderedSet::new(StorageKey::Nested(1)));\nlet n = root.get(&1).unwrap();\nassert!(n.is_empty());\nassert!(n.contains(&"test".to_string()));\n\n// Bug 2: Nested collection is modified without updating the collection itself in the outer collection.\n//\n// This is fixed at the type level in `near_sdk::store` because the values are modified\n// in-place and guarded by regular Rust borrow-checker rules.\nroot.insert(&2, &UnorderedSet::new(StorageKey::Nested(2)));\n\nlet mut nested = root.get(&2).unwrap();\nnested.insert(&"some value".to_string());\n\n// This line would fix the bug:\n// root.insert(&2, &nested);\n\nlet n = root.get(&2).unwrap();\nassert!(n.is_empty());\nassert!(n.contains(&"some value".to_string()));\n'})})]})}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"pagination",children:"Pagination"}),"\n",(0,s.jsxs)(t.p,{children:["Persistent collections such as ",(0,s.jsx)(t.code,{children:"IterableMap/UnorderedMap"}),", ",(0,s.jsx)(t.code,{children:"IterableSet/UnorderedSet"})," and ",(0,s.jsx)(t.code,{children:"Vector"})," may\ncontain more elements than the amount of gas available to read them all.\nIn order to expose them all through view calls, we can use pagination."]}),"\n",(0,s.jsxs)(l.Z,{groupId:"code-tabs",children:[(0,s.jsxs)(a.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:[(0,s.jsxs)(t.p,{children:["With JavaScript this can be done using iterators with ",(0,s.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Iterator/toArray",children:(0,s.jsx)(t.code,{children:"toArray"})})," and ",(0,s.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice",children:(0,s.jsx)(t.code,{children:"slice"})}),"."]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:"  /// Returns multiple elements from the `UnorderedMap`.\n  /// - `from_index` is the index to start from.\n  /// - `limit` is the maximum number of elements to return.\n  @view({})\n  get_updates({ from_index, limit }: { from_index: number, limit:number }) {\n    return this.status_updates.toArray().slice(from_index, limit);\n  }\n"})})]}),(0,s.jsxs)(a.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:[(0,s.jsxs)(t.p,{children:["With Rust this can be done using iterators with ",(0,s.jsx)(t.a,{href:"https://doc.rust-lang.org/std/iter/struct.Skip.html",children:(0,s.jsx)(t.code,{children:"Skip"})})," and ",(0,s.jsx)(t.a,{href:"https://doc.rust-lang.org/std/iter/struct.Take.html",children:(0,s.jsx)(t.code,{children:"Take"})}),". This will only load elements from storage within the range."]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-rust",children:"  #[near(contract_state)]\n  #[derive(PanicOnDefault)]\n  pub struct Contract {\n      pub status_updates: IterableMap<AccountId, String>,\n  }\n\n  #[near]\n  impl Contract {\n      /// Retrieves multiple elements from the `IterableMap`.\n      /// - `from_index` is the index to start from.\n      /// - `limit` is the maximum number of elements to return.\n      pub fn get_updates(&self, from_index: usize, limit: usize) -> Vec<(AccountId, String)> {\n          self.status_updates\n              .iter()\n              .skip(from_index)\n              .take(limit)\n              .collect()\n      }\n  }\n"})})]})]}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"storage-cost",children:"Storage Cost"}),"\n",(0,s.jsx)(t.p,{children:"Your contract needs to lock a portion of their balance proportional to the amount of data they stored in the blockchain. This means that:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If more data is added and the ",(0,s.jsx)(t.strong,{children:"storage increases \u2191"}),", then your contract's ",(0,s.jsx)(t.strong,{children:"balance decreases \u2193"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["If data is deleted and the ",(0,s.jsx)(t.strong,{children:"storage decreases \u2193"}),", then your contract's ",(0,s.jsx)(t.strong,{children:"balance increases \u2191"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Currently, it costs approximately ",(0,s.jsx)(t.strong,{children:"1 \u24c3"})," to store ",(0,s.jsx)(t.strong,{children:"100kb"})," of data."]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsxs)(t.p,{children:["You can save on smart contract storage if using NEAR Account IDs by encoding them using base32. Since they consist of ",(0,s.jsx)(t.code,{children:"[a-z.-_]"})," characters with a maximum length of 64 characters, they can be encoded using 5 bits per character, with terminal ",(0,s.jsx)(t.code,{children:"\\0"}),". Going to a size of 65 * 5 = 325 bits from the original (64 + 4) * 8 = 544 bits. This is a 40% reduction in storage costs"]})}),"\n",(0,s.jsx)(t.admonition,{type:"caution",children:(0,s.jsx)(t.p,{children:"Your contract will panic if you try to store data but don't have NEAR to cover its storage cost"})}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsxs)(t.p,{children:["Be mindful of potential ",(0,s.jsx)(t.a,{href:"/docs/build/smart-contracts/security/storage",children:"small deposit attacks"})]})}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsx)(t.h2,{id:"storage-constraints-on-near",children:"Storage Constraints on NEAR"}),"\n",(0,s.jsx)(t.p,{children:"For storing data on-chain it\u2019s important to keep in mind the following:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"There is a 4mb limit on how much you can upload at once"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Let\u2019s say for example, someone wants to put an NFT purely on-chain (rather than IPFS or some other decentralized storage solution) you\u2019ll have almost an unlimited amount of storage but will have to pay 1 $NEAR per 100kb of storage used."}),"\n",(0,s.jsx)(t.p,{children:"Users will be limited to 4MB per contract call upload due to MAX_GAS constraints. The maximum amount of gas one can attach to a given functionCall is 300TGas."})]})}function j(e={}){const{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(x,{...e})}):x(e)}},85162:(e,t,n)=>{n.d(t,{Z:()=>l});n(67294);var s=n(36905);const r={tabItem:"tabItem_Ymn6"};var i=n(85893);function l(e){var t=e.children,n=e.hidden,l=e.className;return(0,i.jsx)("div",{role:"tabpanel",className:(0,s.Z)(r.tabItem,l),hidden:n,children:t})}},74866:(e,t,n)=>{n.d(t,{Z:()=>w});var s=n(67294),r=n(36905),i=n(12466),l=n(16550),a=n(20469),o=n(91980),c=n(67392),d=n(20812);function h(e){var t,n;return null!=(t=null==(n=s.Children.toArray(e).filter((function(e){return"\n"!==e})).map((function(e){if(!e||(0,s.isValidElement)(e)&&((t=e.props)&&"object"==typeof t&&"value"in t))return e;var t;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:n.filter(Boolean))?t:[]}function u(e){var t=e.values,n=e.children;return(0,s.useMemo)((function(){var e=null!=t?t:function(e){return h(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}(n);return function(e){var t=(0,c.lx)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,n])}function x(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function j(e){var t=e.queryString,n=void 0!==t&&t,r=e.groupId,i=(0,l.k6)(),a=function(e){var t=e.queryString,n=void 0!==t&&t,s=e.groupId;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!s)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=s?s:null}({queryString:n,groupId:r});return[(0,o._X)(a),(0,s.useCallback)((function(e){if(a){var t=new URLSearchParams(i.location.search);t.set(a,e),i.replace(Object.assign({},i.location,{search:t.toString()}))}}),[a,i])]}function p(e){var t,n,r,i,l=e.defaultValue,o=e.queryString,c=void 0!==o&&o,h=e.groupId,p=u(e),m=(0,s.useState)((function(){return function(e){var t,n=e.defaultValue,s=e.tabValues;if(0===s.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!x({value:n,tabValues:s}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+n+'" but none of its children has the corresponding value. Available values are: '+s.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return n}var r=null!=(t=s.find((function(e){return e.default})))?t:s[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:l,tabValues:p})})),g=m[0],b=m[1],f=j({queryString:c,groupId:h}),y=f[0],v=f[1],w=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:h}.groupId),n=(0,d.Nk)(t),r=n[0],i=n[1],[r,(0,s.useCallback)((function(e){t&&i.set(e)}),[t,i])]),S=w[0],k=w[1],A=function(){var e=null!=y?y:S;return x({value:e,tabValues:p})?e:null}();return(0,a.Z)((function(){A&&b(A)}),[A]),{selectedValue:g,selectValue:(0,s.useCallback)((function(e){if(!x({value:e,tabValues:p}))throw new Error("Can't select invalid tab value="+e);b(e),v(e),k(e)}),[v,k,p]),tabValues:p}}var m=n(72389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=n(85893);function f(e){var t=e.className,n=e.block,s=e.selectedValue,l=e.selectValue,a=e.tabValues,o=[],c=(0,i.o5)().blockElementScrollPositionUntilNextRender,d=function(e){var t=e.currentTarget,n=o.indexOf(t),r=a[n].value;r!==s&&(c(t),l(r))},h=function(e){var t,n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":var s,r=o.indexOf(e.currentTarget)+1;n=null!=(s=o[r])?s:o[0];break;case"ArrowLeft":var i,l=o.indexOf(e.currentTarget)-1;n=null!=(i=o[l])?i:o[o.length-1]}null==(t=n)||t.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t),children:a.map((function(e){var t=e.value,n=e.label,i=e.attributes;return(0,b.jsx)("li",Object.assign({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,ref:function(e){return o.push(e)},onKeyDown:h,onClick:d},i,{className:(0,r.Z)("tabs__item",g.tabItem,null==i?void 0:i.className,{"tabs__item--active":s===t}),children:null!=n?n:t}),t)}))})}function y(e){var t=e.lazy,n=e.children,i=e.selectedValue,l=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){var a=l.find((function(e){return e.props.value===i}));return a?(0,s.cloneElement)(a,{className:(0,r.Z)("margin-top--md",a.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:l.map((function(e,t){return(0,s.cloneElement)(e,{key:t,hidden:e.props.value!==i})}))})}function v(e){var t=p(e);return(0,b.jsxs)("div",{className:(0,r.Z)("tabs-container",g.tabList),children:[(0,b.jsx)(f,Object.assign({},t,e)),(0,b.jsx)(y,Object.assign({},t,e))]})}function w(e){var t=(0,m.Z)();return(0,b.jsx)(v,Object.assign({},e,{children:h(e.children)}),String(t))}},71183:(e,t,n)=>{n.d(t,{O2:()=>j,Ey:()=>m,SQ:()=>p});var s=n(67294),r=n(74866),i=n(85162),l=n(74165),a=n(15861),o=n(1841),c=n.n(o),d=n(85893);function h(){return(h=(0,a.Z)((0,l.Z)().mark((function e(t,n,s){var r,i,a,o;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=localStorage.getItem(t+"-until"))&&i>Date.now())){e.next=5;break}r=localStorage.getItem(t),e.next=18;break;case 5:return e.prev=5,e.next=8,fetch(t);case 8:return e.next=10,e.sent.text();case 10:r=e.sent,localStorage.setItem(t,r),localStorage.setItem(t+"-until",Date.now()+6e4),e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(5),e.abrupt("return","Error fetching code, please try reloading");case 18:return a=r.split("\n"),n=n?Number(n)-1:0,s=s?Number(s):a.length,a=a.slice(n,s),o=a.reduce((function(e,t){if(0===t.length)return e;var n=t.match(/^\s+/);return n?Math.min(e,n[0].length):0}),1/0),e.abrupt("return",a.map((function(e){return e.slice(o)})).join("\n"));case 24:case"end":return e.stop()}}),e,null,[[5,15]])})))).apply(this,arguments)}const u=function(e){var t=e.url,n=e.start,r=e.end,i=e.language,l=e.fname,a=e.metastring,o=(0,s.useState)("Loading..."),u=o[0],x=o[1];return(0,s.useEffect)((function(){var e=function(e){var t=e.slice(e.indexOf("https")).split("#"),n=t[0],s=(t[1],new URL(n).pathname.split("/").slice(1)),r=s[0],i=s[1];return s[2],"https://raw.githubusercontent.com/"+r+"/"+i+"/"+s[3]+"/"+s.slice(4).join("/")}(t),s=function(e,t,n){return h.apply(this,arguments)}(e,n,r);s.then((function(e){return x(e)}))})),(0,d.jsxs)("div",{fname:l,children:[(0,d.jsx)(c(),{language:i,metastring:a+" showLineNumbers",children:u}),(0,d.jsx)("div",{style:{fontSize:"0.9em",fontWeight:600,color:"rgb(14, 117, 221)",textAlign:"center",paddingBottom:"13px",textDecoration:"underline"},children:(0,d.jsx)("a",{href:t,target:"_blank",rel:"noreferrer noopener",children:"See full example on GitHub"})})]})};var x={rust:"\ud83e\udd80 Rust",js:"\ud83c\udf10 Javascript",ts:"\ud83c\udf10 Typescript"};function j(e){var t=e.children;return Array.isArray(t)||(t=[t]),(0,d.jsx)(r.Z,{className:"language-tabs",groupId:"code-tabs",children:t.map((function(e,t){return(0,d.jsx)(i.Z,{value:e.props.value,label:x[e.props.value],children:e})}))})}function p(e){var t=e.children,n=e.language,s=e.showSingleFName;return Array.isArray(t)||(t=[t]),t=t.map((function(e){return function(e,t){var n=e.props,s=(n.children,n.url),r=n.start,i=n.end,l=n.fname;if(e.type===m)return m({url:s,start:r,end:i,language:t,fname:l});return e}(e,n)})),1!=t.length||s?(0,d.jsx)(r.Z,{className:"file-tabs",children:t.map((function(e,t){return(0,d.jsx)(i.Z,{value:t,label:e.props.fname,children:e})}))}):(0,d.jsx)(i.Z,{value:0,label:t[0].props.fname,children:t[0]})}function m(e){var t=e.url,n=e.start,s=e.end,r=e.language,i=e.fname,l=e.metastring;return u({url:t,start:n,end:s,language:r,fname:i,metastring:l})}}}]);